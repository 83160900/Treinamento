<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin-RH | Funcionários</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root { 
            --plugin-primary: #6366f1;
            --plugin-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --text-dark: #0f172a;
            --text-muted: #64748b;
            --bg-glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            background: transparent;
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: var(--text-dark); 
            min-height: 100vh;
        }

        .container-fluid { padding: 1rem; max-width: 100%; margin: 0 auto; }

        .card-header-rh { 
            background: var(--plugin-gradient); 
            padding: 0.75rem 1.5rem; 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.3); 
            margin-bottom: 0.75rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: white;
        }

        .card-body-rh { 
            background: var(--bg-glass); 
            backdrop-filter: blur(12px);
            border-radius: 1rem; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
            overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0;
        }

        .table-rh { width: 100%; border-collapse: collapse; }
        .table-rh th { 
            background: rgba(248, 250, 252, 0.8); 
            padding: 0.75rem 1rem; 
            font-size: 0.65rem; 
            font-weight: 800; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            border-bottom: 2px solid rgba(0,0,0,0.05); 
        }
        .table-rh td { 
            padding: 0.75rem 1rem; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            font-size: 0.85rem; 
            font-weight: 600; 
        }
        .table-rh tr:hover { background-color: rgba(99, 102, 241, 0.05); }

        .btn-plugin {
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 0.6rem;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-plugin-white {
            background: white;
            color: var(--plugin-primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-plugin-white:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-plugin-primary {
            background: var(--plugin-gradient);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }

        .btn-plugin-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .form-control, .form-select {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--plugin-primary);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="card-header-rh">
            <div class="fw-800" style="font-size: 1.1rem; letter-spacing: -0.5px;"><i class="fas fa-plug me-2"></i> Plugin-RH <span class="mx-2" style="opacity: 0.5">|</span> <small class="fw-400" style="font-size: 0.8rem">Gestão de Equipe</small></div>
            <button class="btn-plugin btn-plugin-white" onclick="abrirModalFuncionario()">
                <i class="fas fa-plus-circle"></i> Novo Funcionário
            </button>
        </header>

        <div class="card-body-rh">
            <table class="table-rh">
                <thead>
                    <tr>
                        <th style="width: 70px;">Filial</th>
                        <th style="width: 100px;">Matrícula</th>
                        <th>Nome Completo</th>
                        <th style="width: 130px;">CPF</th>
                        <th style="width: 120px;">Perfil</th>
                        <th class="text-center" style="width: 140px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-funcionarios">
                    <!-- Dinâmico -->
                </tbody>
            </table>
            <div id="loading-spinner" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mt-2 fw-bold small">SINCRONIZANDO DADOS...</p>
            </div>
            <div id="no-data-alert" class="text-center py-5 d-none">
                <i class="fas fa-user-slash fa-3x text-light mb-3"></i>
                <p class="text-muted">Nenhum colaborador encontrado.</p>
            </div>
        </div>
    </div>

    <!-- Modal Funcionário -->
    <div class="modal fade" id="modalFuncionario" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-800">Dados do Colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formFuncionario">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold text-muted">FILIAL</label>
                                <select id="f-filial" class="form-select form-select-lg border-light-subtle" style="font-size: 0.9rem;" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label small fw-bold text-muted">MATRÍCULA</label>
                                <input type="text" id="f-matricula" class="form-control form-control-lg border-light-subtle" style="font-size: 0.9rem;" maxlength="6" required placeholder="000001">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">NOME COMPLETO</label>
                            <input type="text" id="f-nome" class="form-control form-control-lg border-light-subtle" style="font-size: 0.9rem;" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label small fw-bold text-muted">CPF</label>
                                <input type="text" id="f-cpf" class="form-control form-control-lg border-light-subtle" style="font-size: 0.9rem;" maxlength="11" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label small fw-bold text-muted">PERFIL</label>
                                <select id="f-perfil" class="form-select form-select-lg border-light-subtle" style="font-size: 0.9rem;">
                                    <option value="COLABORADOR">Colaborador</option>
                                    <option value="GESTOR">Gestor</option>
                                    <option value="ADMIN">Administrador</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">DEPARTAMENTO</label>
                            <select id="f-depto" class="form-select form-select-lg border-light-subtle" style="font-size: 0.9rem;">
                                <option value="">Selecione um departamento...</option>
                            </select>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">TURNO DE HORÁRIO</label>
                                <select id="f-horario" class="form-select form-select-lg border-light-subtle" style="font-size: 0.9rem;">
                                    <option value="">Selecione um turno...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">ESCALA SEMANAL</label>
                                <select id="f-escala" class="form-select form-select-lg border-light-subtle" style="font-size: 0.9rem;">
                                    <option value="">Selecione uma escala...</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light p-3" style="border-radius: 0 0 1rem 1rem;">
                    <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn-plugin btn-plugin-primary px-4 shadow-sm" onclick="salvarFuncionario()">Efetivar Cadastro</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let modalFunc;
        let currentUserPerfil = null;

        async function carregarFiliais() {
            try {
                const resp = await fetch('/api/filiais');
                const filiais = await resp.json();
                const select = document.getElementById('f-filial');
                select.innerHTML = '<option value="">Selecione...</option>';
                filiais.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.codFilial;
                    opt.textContent = `${f.codFilial} - ${f.nome}`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar filiais:', error);
            }
        }

        async function carregarHorarios() {
            try {
                const resp = await fetch('/api/horarios');
                const horarios = await resp.json();
                const select = document.getElementById('f-horario');
                select.innerHTML = '<option value="">Selecione um turno...</option>';
                horarios.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.textContent = `${h.filial} - ${h.descricao} (${h.e1}-${h.s2})`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
            }
        }

        async function carregarEscalas() {
            try {
                const resp = await fetch('/api/escalas');
                const escalas = await resp.json();
                const select = document.getElementById('f-escala');
                select.innerHTML = '<option value="">Selecione uma escala...</option>';
                escalas.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    opt.textContent = `${e.filial} - Escala ${e.codigo}`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar escalas:', error);
            }
        }

        async function carregarDepartamentos() {
            try {
                const resp = await fetch('/api/departamentos');
                const departamentos = await resp.json();
                const select = document.getElementById('f-depto');
                select.innerHTML = '<option value="">Selecione um departamento...</option>';
                departamentos.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.nome; // Mantemos o nome como valor para compatibilidade com o campo String departamento
                    opt.textContent = `${d.filial} - ${d.nome}`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar departamentos:', error);
            }
        }

        async function carregarFuncionarios() {
            const spinner = document.getElementById('loading-spinner');
            const noData = document.getElementById('no-data-alert');
            const tbody = document.getElementById('lista-funcionarios');
            const btnNovo = document.querySelector('button[onclick="abrirModalFuncionario()"]');
            
            try {
                spinner.classList.remove('d-none');
                noData.classList.add('d-none');
                tbody.innerHTML = '';

                // Busca perfil do usuário logado para ajustar UI
                const meResp = await fetch('/api/auth/me');
                if (!meResp.ok) throw new Error('Erro ao identificar usuário');
                const meData = await meResp.json();
                
                if (!meData.autenticado) {
                    window.parent.location.reload();
                    return;
                }
                
                currentUserPerfil = meData.perfil;

                if (currentUserPerfil === 'ADMIN' || currentUserPerfil === 'GESTOR') {
                    btnNovo.classList.remove('d-none');
                } else {
                    btnNovo.classList.add('d-none');
                }

                const resp = await fetch('/api/funcionarios');
                if (resp.status === 403) {
                    alert('Acesso negado.');
                    spinner.classList.add('d-none');
                    return;
                }
                
                const data = await resp.json();
                
                spinner.classList.add('d-none');

                if (!Array.isArray(data) || data.length === 0) {
                    noData.classList.remove('d-none');
                    return;
                }

                data.forEach(f => {
                    const tr = document.createElement('tr');
                    
                    let acoes = `
                        <button class="btn btn-sm btn-outline-info border-0 shadow-sm p-1 me-1" onclick='editarFuncionario(${JSON.stringify(f)}, true)' title="Visualizar" style="width: 30px; height: 30px;">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;

                    if (currentUserPerfil === 'ADMIN' || currentUserPerfil === 'GESTOR') {
                        acoes += `
                            <button class="btn btn-sm btn-outline-warning border-0 shadow-sm p-1 me-1" onclick='editarFuncionario(${JSON.stringify(f)})' title="Editar" style="width: 30px; height: 30px;"><i class="fas fa-edit"></i></button>
                        `;
                    }
                    
                    if (currentUserPerfil === 'ADMIN') {
                        acoes += `
                            <button class="btn btn-sm btn-outline-danger border-0 shadow-sm p-1" onclick="excluirFuncionario('${f.filial}', '${f.matricula}')" title="Excluir" style="width: 30px; height: 30px;"><i class="fas fa-trash"></i></button>
                        `;
                    }

                    tr.innerHTML = `
                        <td>${f.filial}</td>
                        <td><span class="badge bg-white text-primary border-0 shadow-sm px-2 py-1" style="font-size: 0.8rem;">${f.matricula}</span></td>
                        <td class="fw-bold text-dark">${f.nome}</td>
                        <td>${f.cpf}</td>
                        <td><span class="badge bg-light text-secondary" style="font-size: 0.7rem;">${f.perfil}</span></td>
                        <td class="text-center">${acoes}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error(error);
                spinner.classList.add('d-none');
                alert('Erro ao carregar lista de funcionários.');
            }
        }

        function abrirModalFuncionario(viewOnly = false) {
            if(!modalFunc) modalFunc = new bootstrap.Modal(document.getElementById('modalFuncionario'));
            document.getElementById('formFuncionario').reset();
            
            // Habilita/Desabilita campos conforme o modo
            const inputs = document.querySelectorAll('#formFuncionario input, #formFuncionario select');
            inputs.forEach(input => input.disabled = viewOnly);
            
            // Botão de salvar só aparece se não for apenas visualização
            document.querySelector('button[onclick="salvarFuncionario()"]').style.display = viewOnly ? 'none' : 'block';
            document.querySelector('button[onclick="salvarFuncionario()"]').innerText = 'Efetivar Cadastro';

            if (!viewOnly) {
                document.getElementById('f-filial').disabled = false;
                document.getElementById('f-matricula').disabled = false;
            }
            
            modalFunc.show();
        }

        function editarFuncionario(f, viewOnly = false) {
            abrirModalFuncionario(viewOnly);
            
            const btnSalvar = document.querySelector('button[onclick="salvarFuncionario()"]');
            if (!viewOnly) {
                btnSalvar.innerText = 'Salvar Alterações';
            }

            document.getElementById('f-filial').value = f.filial;
            document.getElementById('f-matricula').value = f.matricula;
            document.getElementById('f-nome').value = f.nome;
            document.getElementById('f-cpf').value = f.cpf;
            document.getElementById('f-perfil').value = f.perfil;
            document.getElementById('f-depto').value = f.departamento;
            document.getElementById('f-horario').value = f.idHorario || '';
            document.getElementById('f-escala').value = f.idEscala || '';

            // Mesmo em edição (não visualização), filial e matrícula costumam ser chaves e não devem mudar
            // GESTOR também não deve mudar o perfil (permissão reservada ao ADMIN)
            if (!viewOnly) {
                document.getElementById('f-filial').disabled = true;
                document.getElementById('f-matricula').disabled = true;
                
                if (currentUserPerfil === 'GESTOR') {
                    document.getElementById('f-perfil').disabled = true;
                    document.getElementById('f-depto').disabled = true;
                }
            }
        }

        async function salvarFuncionario() {
            // Se o campo estiver desabilitado, o .value pode não ser pego corretamente em alguns navegadores se usarmos FormData, 
            // mas aqui estamos pegando via ID direto, então funciona.
            const f = {
                filial: document.getElementById('f-filial').value,
                matricula: document.getElementById('f-matricula').value,
                nome: document.getElementById('f-nome').value,
                cpf: document.getElementById('f-cpf').value,
                perfil: document.getElementById('f-perfil').value,
                departamento: document.getElementById('f-depto').value,
                idHorario: document.getElementById('f-horario').value || null,
                idEscala: document.getElementById('f-escala').value || null
            };

            if (!f.filial || !f.matricula || !f.nome || !f.cpf) {
                alert('Filial, Matrícula, Nome e CPF são obrigatórios!');
                return;
            }

            try {
                const response = await fetch('/api/funcionarios', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(f)
                });

                if (response.ok) {
                    modalFunc.hide();
                    carregarFuncionarios();
                } else {
                    const erro = await response.text();
                    alert('Erro ao salvar funcionário: ' + erro);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro na comunicação com o servidor.');
            }
        }

        async function excluirFuncionario(filial, matricula) {
            if(!confirm('Deseja excluir este funcionário?')) return;
            await fetch(`/api/funcionarios/${filial}/${matricula}`, { method: 'DELETE' });
            carregarFuncionarios();
        }

        window.onload = () => {
            carregarFiliais();
            carregarHorarios();
            carregarEscalas();
            carregarDepartamentos();
            carregarFuncionarios();
        };
    </script>
</body>
</html>
