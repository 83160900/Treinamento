<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin-RH | Espelho de Ponto</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --plugin-primary: #6366f1;
            --plugin-primary-dark: #4f46e5;
            --plugin-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            
            /* Paleta de Status */
            --color-util: #6366f1;
            --color-sabado: #f59e0b;
            --color-domingo: #ef4444;
            --color-feriado: #10b981;
            
            --text-dark: #0f172a;
            --text-muted: #64748b;
            --bg-glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            background: transparent;
            color: var(--text-dark);
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0; padding: 0;
            min-height: 100vh;
        }

        .meurh-container {
            padding: 1rem;
            max-width: 100%;
            margin: 0 auto;
        }

        /* Cabeçalho Premium */
        .meurh-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            background: var(--plugin-gradient);
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.3);
            color: white;
            position: sticky;
            top: 0.5rem;
            z-index: 1000;
        }

        .meurh-title {
            font-size: 1.1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.5px;
            white-space: nowrap;
        }

        /* Efeito Glassmorphism no Card Principal */
        .meurh-card {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .meurh-toolbar {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .meurh-table {
            width: 100%;
            border-collapse: collapse;
        }

        .meurh-table th {
            background: rgba(248, 250, 252, 0.8);
            padding: 0.6rem 0.4rem;
            text-align: center;
            font-size: 0.65rem;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .meurh-table td {
            padding: 0.5rem 0.4rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .meurh-table tr:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }

        /* Botões Estilo Moderno */
        .btn-plugin {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 0.6rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-plugin-white {
            background: white;
            color: var(--plugin-primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-plugin-white:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background: #f8fafc;
        }

        .btn-plugin-primary {
            background: var(--plugin-gradient);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }

        .btn-plugin-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        /* Sincronia de Cores e Ícones */
        .icon-status {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-size: 0.85rem;
        }

        .status-util { background: rgba(99, 102, 241, 0.1); color: var(--color-util); }
        .status-sabado { background: rgba(245, 158, 11, 0.1); color: var(--color-sabado); }
        .status-domingo { background: rgba(239, 68, 68, 0.1); color: var(--color-domingo); }
        .status-feriado { background: rgba(16, 185, 129, 0.1); color: var(--color-feriado); }

        .total-box {
            background: white;
            border-radius: 0.75rem;
            padding: 0.75rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .total-box:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }

        .total-box .value {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--plugin-primary);
            display: block;
        }

        .total-box .label {
            font-size: 0.6rem;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body>
    <div class="meurh-container">
        <!-- Cabeçalho -->
        <header class="meurh-header">
            <div class="meurh-title">
                <i class="fas fa-plug fa-lg"></i>
                Plugin-RH <span class="mx-2" style="opacity: 0.5;">|</span> <small>Espelho de Ponto</small>
            </div>
            <div class="d-flex gap-3">
                <button id="btnBaterPonto" class="btn-plugin btn-plugin-white" type="button">
                    <i class="fas fa-hand-pointer"></i> Bater Ponto
                </button>
                <button id="btn-trocar-funcionario" class="btn-plugin btn-plugin-white" style="display:none;" onclick="abrirModalSelecao()">
                    <i class="fas fa-users-viewfinder"></i> Selecionar Funcionário
                </button>
                <button id="btn-calcular-folha" class="btn-plugin btn-plugin-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#panelCalculo" style="display:none;">
                    <i class="fas fa-calculator"></i> Calcular Apontamentos
                </button>
                <div class="dropdown">
                    <button class="btn-plugin btn-plugin-outline-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-layer-group"></i> Ações Manual
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2" style="border-radius: 0.75rem;">
                        <li><a class="dropdown-item rounded-2 py-2" href="#" onclick="prepararAcao('incluir')"><i class="fas fa-plus-circle text-primary me-2"></i>Incluir Batida</a></li>
                        <li><a class="dropdown-item rounded-2 py-2" href="#" onclick="prepararAcao('alterar')"><i class="fas fa-pen-to-square text-warning me-2"></i>Ajustar Batida</a></li>
                        <li><a class="dropdown-item rounded-2 py-2" href="#" onclick="prepararAcao('abonar')"><i class="fas fa-file-signature text-info me-2"></i>Abonar Marcação</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item rounded-2 py-2 text-danger" href="#" onclick="prepararAcao('excluir')"><i class="fas fa-trash-can me-2"></i>Excluir Batida</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Cartão da Tabela -->
        <div class="meurh-card">
            <div class="meurh-toolbar">
                <div class="d-flex flex-column gap-1">
                    <div id="periodo-info" class="fw-bold text-dark">
                        <i class="fas fa-calendar-range me-2 text-primary"></i>Carregando período...
                    </div>
                    <div id="horario-info" class="fw-bold text-muted small" style="display: none;">
                        <i class="fas fa-clock me-2 text-secondary"></i>Horário: <span id="horario-descricao">-</span>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex gap-3">
                        <div class="legend-item small d-flex align-items-center gap-1"><div class="icon-status status-util" style="width: 20px; height: 20px; font-size: 10px;"><i class="fas fa-briefcase"></i></div> Útil</div>
                        <div class="legend-item small d-flex align-items-center gap-1"><div class="icon-status status-sabado" style="width: 20px; height: 20px; font-size: 10px;"><i class="fas fa-umbrella-beach"></i></div> Sáb.</div>
                        <div class="legend-item small d-flex align-items-center gap-1"><div class="icon-status status-domingo" style="width: 20px; height: 20px; font-size: 10px;"><i class="fas fa-mug-hot"></i></div> Dom.</div>
                        <div class="legend-item small d-flex align-items-center gap-1"><div class="icon-status status-feriado" style="width: 20px; height: 20px; font-size: 10px;"><i class="fas fa-holly-berry"></i></div> Fer.</div>
                    </div>
                </div>
                <div class="d-flex gap-3">
                    <div id="matricula-exibicao" class="badge bg-white text-primary border px-2 py-1 d-flex align-items-center" style="border-radius: 0.5rem; font-weight: 800; font-size: 0.75rem;">
                        MATRÍCULA: -
                    </div>
                </div>
            </div>

            <table class="meurh-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">ST</th>
                        <th>Filial</th>
                        <th>Matrícula</th>
                        <th>Data</th>
                        <th>Entrada 1</th>
                        <th>Saída 1</th>
                        <th>Entrada 2</th>
                        <th>Saída 2</th>
                        <th style="width: 40px;"><i class="fas fa-location-dot"></i></th>
                        <th style="width: 100px;">Origem</th>
                        <th>Abono</th>
                    </tr>
                </thead>
                <tbody id="tabela-marcacoes">
                    <!-- Conteúdo Dinâmico -->
                </tbody>
            </table>
        </div>
    </div>


    <!-- Modal Mapa e Confirmação de Ponto -->
    <div class="modal fade" id="modalMapaPonto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom py-2 px-3">
                    <h6 class="modal-title fw-bold text-dark"><i class="fas fa-map-location-dot me-2 text-primary"></i>Confirmar Localização</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="mapa-ponto" style="height: 250px; width: 100%;"></div>
                    <div class="p-3 bg-light">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fas fa-location-dot text-danger me-2" style="font-size: 0.8rem;"></i>
                            <span class="fw-bold" style="font-size: 0.7rem; color: #64748b;">ENDEREÇO IDENTIFICADO:</span>
                        </div>
                        <div id="endereco-identificado" class="fw-bold text-dark" style="font-size: 0.85rem; line-height: 1.2;">Buscando endereço...</div>
                        <input type="hidden" id="lat-ponto">
                        <input type="hidden" id="lng-ponto">
                    </div>
                </div>
                <div class="modal-footer bg-white border-top p-2">
                    <button type="button" class="btn btn-sm btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnConfirmarPonto" class="btn-plugin btn-plugin-primary px-3 py-2" style="font-size: 0.85rem;">
                        <i class="fas fa-check me-2"></i>Confirmar Batida
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Seleção de Funcionário -->
    <div class="modal fade" id="modalSelecao" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-users me-2 text-primary"></i>Selecionar Funcionário da Equipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <input type="text" id="filtro-func" class="form-control" placeholder="Filtrar por nome, matrícula ou departamento..." onkeyup="filtrarListaFunc()">
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Filial</th>
                                    <th>Matrícula</th>
                                    <th>Nome</th>
                                    <th>Departamento</th>
                                    <th class="text-end">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="lista-funcionarios">
                                <!-- Carregado dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="offcanvas offcanvas-end border-0 shadow" tabindex="-1" id="panelCalculo" style="width: 450px; background: #f8fafc;">
        <div class="offcanvas-header border-bottom bg-white">
            <h5 class="offcanvas-title fw-bold text-dark"><i class="fas fa-calculator me-2 text-primary"></i>Cálculo de Apontamentos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3 p-3 bg-white rounded-3 shadow-sm border">
                <label class="form-label small fw-bold text-muted mb-2"><i class="fas fa-filter me-1"></i> TIPO DE CÁLCULO</label>
                <div class="d-flex gap-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipoCalculo" id="calc-individual" value="individual" checked onchange="toggleFiltroCalc()">
                        <label class="form-check-label small fw-bold" for="calc-individual">Individual</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipoCalculo" id="calc-lote" value="lote" onchange="toggleFiltroCalc()">
                        <label class="form-check-label small fw-bold" for="calc-lote">Lote</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipoCalculo" id="calc-depto" value="depto" onchange="toggleFiltroCalc()">
                        <label class="form-check-label small fw-bold" for="calc-depto">Depto</label>
                    </div>
                </div>
                <div id="div-filtro-depto" style="display: none;">
                    <select id="calc-depto-select" class="form-select form-select-sm border-light-subtle">
                        <option value="">Selecione o Departamento...</option>
                    </select>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="total-box">
                        <span id="total-trabalhado" class="value">00:00</span>
                        <span class="label" id="label-total-trabalhado">Total Trab.</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="total-box">
                        <span id="total-almoco" class="value">00:00</span>
                        <span class="label">Total Almoço</span>
                    </div>
                </div>
                <div class="col-12">
                    <div class="total-box bg-info bg-opacity-10">
                        <span id="total-abonado" class="value" style="color: #0ea5e9;">00:00</span>
                        <span class="label">Total Abonado</span>
                    </div>
                </div>
            </div>

            <div class="alert bg-white border-0 shadow-sm small mb-3 text-muted p-2" style="border-radius: 0.75rem; font-size: 0.75rem;">
                <i class="fas fa-info-circle me-1 text-primary"></i>
                Cálculo: <strong>E1 às S2</strong> menos almoço (<strong>S1 às E2</strong>).
            </div>
            
            <button class="btn-plugin btn-plugin-primary w-100 mb-2 justify-content-center py-2" onclick="calcularFolha()">
                <i class="fas fa-wand-magic-sparkles me-1"></i>Processar Período
            </button>

            <button id="btn-extrair-txt" class="btn btn-outline-secondary w-100 mb-2 justify-content-center py-2" onclick="extrairTXT()" style="border-radius: 0.75rem; font-weight: 700; font-size: 0.85rem; display: none;">
                <i class="fas fa-file-export me-1"></i>Extrair em .TXT
            </button>

            <div id="div-progresso" style="display: none;">
                <div class="progress mb-1" style="height: 10px; border-radius: 5px;">
                    <div id="barra-progresso" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="text-center mb-3">
                    <small id="label-progresso" class="text-muted fw-bold" style="font-size: 0.65rem;">Processando: 0/0</small>
                </div>
            </div>

            <div id="resultado-calculo" class="list-group list-group-flush rounded-4 overflow-hidden shadow-sm">
                <div class="text-center py-5 bg-white">
                    <i class="fas fa-calculator fa-3x text-light mb-3"></i>
                    <p class="text-muted small">Clique no botão acima para processar.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Abono -->
    <div class="modal fade" id="modalAbono" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 0.5rem;">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold text-dark"><i class="fas fa-file-signature text-info me-2"></i>Abonar Marcação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formAbono">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Abono</label>
                                <select id="a-abono" class="form-select border-light-subtle" required>
                                    <option value="">Selecione o motivo...</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Data</label>
                                <input type="date" id="a-data" class="form-control border-light-subtle" required>
                            </div>
                            <div class="col-md-12">
                                <div class="form-check form-switch p-3 bg-light rounded-3">
                                    <input class="form-check-input" type="checkbox" id="a-diatodo" checked onchange="toggleAbonoHoras()">
                                    <label class="form-check-label fw-bold small ms-2" for="a-diatodo">Abonar Dia Todo</label>
                                </div>
                            </div>
                            <div id="div-horas-abono" class="col-md-12" style="display: none;">
                                <label class="form-label small fw-bold text-muted">Quantidade de Horas (HH:mm)</label>
                                <input type="text" id="a-horas" class="form-control border-light-subtle" placeholder="00:00">
                                <small class="text-muted">Informe as horas e minutos que deseja abonar.</small>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Justificativa</label>
                                <textarea id="a-justificativa" class="form-control border-light-subtle" rows="2" placeholder="Descreva o motivo do abono..."></textarea>
                            </div>
                            <div id="div-anexo" class="col-md-12" style="display: none;">
                                <label class="form-label small fw-bold text-muted">Anexo do Documento</label>
                                <input type="file" id="a-arquivo" class="form-control border-light-subtle">
                                <small class="text-danger">* Este abono exige o upload de um documento.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light border-top p-3">
                    <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn-plugin btn-plugin-primary px-4" onclick="salvarAbono()">Confirmar Abono</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Inclusão Manual -->
    <div class="modal fade" id="modalManual" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 0.5rem;">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold text-dark">Operação de Ponto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formManual">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted uppercase">Filial</label>
                                <select id="m-filial" class="form-select border-light-subtle">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Matrícula</label>
                                <input type="text" id="m-matricula" class="form-control border-light-subtle" maxlength="6" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Data do Registro</label>
                                <input type="date" id="m-data" class="form-control border-light-subtle" required>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small fw-bold text-muted">Entrada 1</label>
                                <input type="text" id="m-e1" class="form-control" placeholder="00:00">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small fw-bold text-muted">Saída 1</label>
                                <input type="text" id="m-s1" class="form-control" placeholder="00:00">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small fw-bold text-muted">Entrada 2</label>
                                <input type="text" id="m-e2" class="form-control" placeholder="00:00">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label small fw-bold text-muted">Saída 2</label>
                                <input type="text" id="m-s2" class="form-control" placeholder="00:00">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light border-top p-3">
                    <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnSalvar" class="btn-plugin btn-plugin-primary px-4" onclick="salvarManual()">Efetivar Batida</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let marker;
        const modalMapaPonto = new bootstrap.Modal(document.getElementById('modalMapaPonto'));

        document.getElementById('btnBaterPonto').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => abrirMapaPonto(position.coords.latitude, position.coords.longitude),
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        alert('Não foi possível obter sua localização. O ponto será registrado sem coordenadas.');
                        registrarPonto(null, null, null);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                alert('Geolocalização não suportada pelo navegador.');
                registrarPonto(null, null, null);
            }
        });

        async function abrirMapaPonto(lat, lng) {
            document.getElementById('lat-ponto').value = lat;
            document.getElementById('lng-ponto').value = lng;
            document.getElementById('endereco-identificado').innerText = 'Buscando endereço...';
            
            modalMapaPonto.show();

            // Inicializa o mapa Leaflet
            setTimeout(() => {
                if (!map) {
                    map = L.map('mapa-ponto').setView([lat, lng], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    marker = L.marker([lat, lng]).addTo(map);
                } else {
                    map.setView([lat, lng], 16);
                    marker.setLatLng([lat, lng]);
                    map.invalidateSize();
                }
            }, 500);

            // Busca o endereço (Reverse Geocoding)
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                const endereco = data.display_name || 'Endereço não encontrado';
                document.getElementById('endereco-identificado').innerText = endereco;
            } catch (err) {
                console.error('Erro ao buscar endereço:', err);
                document.getElementById('endereco-identificado').innerText = 'Erro ao identificar endereço. Coordenadas serão salvas.';
            }
        }

        document.getElementById('btnConfirmarPonto').addEventListener('click', function() {
            const lat = document.getElementById('lat-ponto').value;
            const lng = document.getElementById('lng-ponto').value;
            const endereco = document.getElementById('endereco-identificado').innerText;
            
            modalMapaPonto.hide();
            registrarPonto(lat, lng, endereco);
        });

        async function registrarPonto(lat, lng, endereco) {
            try {
                // Feedback visual de carregamento
                const btn = document.getElementById('btnConfirmarPonto');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registrando...';

                const response = await fetch('/api/marcacoes/bater-ponto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng, endereco: endereco })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Em vez de alert apenas, vamos mostrar uma mensagem de sucesso bonita
                    document.body.insertAdjacentHTML('beforeend', `
                        <div id="sucesso-ponto" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;">
                            <div class="alert alert-success shadow-lg border-0 d-flex align-items-center p-4" style="border-radius: 1rem; background: #10b981; color: white;">
                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                <div>
                                    <h6 class="fw-bold mb-1">${data.message}</h6>
                                    <p class="small mb-0 opacity-75">Horário registrado: <strong>${data.hora}</strong></p>
                                </div>
                            </div>
                        </div>
                    `);

                    setTimeout(() => {
                        location.reload();
                    }, 2500);
                } else {
                    const error = await response.text();
                    alert('Erro ao registrar ponto: ' + error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (err) {
                console.error(err);
                alert('Erro na conexão com o servidor.');
                document.getElementById('btnConfirmarPonto').disabled = false;
            }
        }

        let feriadosCadastrados = [];
        let abonosCadastrados = [];
        let escalaFuncionario = null;
        let extrasCadastrados = [];
        let modalSelecao;
        let funcionariosEquipe = [];
        let horarioFuncionario = null;
        let aprovacoesPendentes = [];
        let departamentosCadastrados = [];
        let funcionarioSelecionado = null;
        let dadosLoteExport = [];

        async function carregarDepartamentos() {
            try {
                const resp = await fetch('/api/departamentos');
                departamentosCadastrados = await resp.json();
                const select = document.getElementById('calc-depto-select');
                if (select) {
                    select.innerHTML = '<option value="">Selecione o Departamento...</option>';
                    departamentosCadastrados.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.nome;
                        opt.textContent = `${d.filial} - ${d.nome}`;
                        select.appendChild(opt);
                    });
                }
            } catch (e) { console.error('Erro ao carregar departamentos:', e); }
        }

        function toggleFiltroCalc() {
            const tipo = document.querySelector('input[name="tipoCalculo"]:checked').value;
            document.getElementById('div-filtro-depto').style.display = (tipo === 'depto') ? 'block' : 'none';
            
            // Se mudar para lote ou depto, oculta o botão de extração individual se estiver visível
            if (tipo !== 'individual') {
                document.getElementById('btn-extrair-txt').style.display = 'none';
                document.getElementById('resultado-calculo').innerHTML = `
                    <div class="text-center py-5 bg-white">
                        <i class="fas fa-layer-group fa-3x text-light mb-3"></i>
                        <p class="text-muted small">Clique em Processar para calcular o ${tipo === 'lote' ? 'lote completo' : 'departamento'}.</p>
                    </div>`;
            } else {
                // Se voltar para individual, mostra o estado inicial ou o que estava
                document.getElementById('resultado-calculo').innerHTML = `
                    <div class="text-center py-5 bg-white">
                        <i class="fas fa-calculator fa-3x text-light mb-3"></i>
                        <p class="text-muted small">Clique no botão acima para processar.</p>
                    </div>`;
            }
            
            // Limpa totais
            document.getElementById('total-trabalhado').innerText = '00:00';
            document.getElementById('total-almoco').innerText = '00:00';
            document.getElementById('total-abonado').innerText = '00:00';
        }

        async function carregarAprovacoesPendentes(matricula) {
            try {
                // Busca tanto PENDENTE (Gestor) quanto EM_EFETIVACAO (Admin)
                const resp1 = await fetch(`/api/aprovacoes?status=PENDENTE`);
                const pendentes = await resp1.json();
                
                const resp2 = await fetch(`/api/aprovacoes?status=EM_EFETIVACAO`);
                const emEfetivacao = await resp2.json();
                
                const todas = [...pendentes, ...emEfetivacao];
                aprovacoesPendentes = todas.filter(a => a.matricula === matricula);
            } catch (e) { console.error('Erro ao carregar aprovações:', e); }
        }

        async function carregarAbonosGlobal() {
            try {
                const resp = await fetch('/api/abonos');
                abonosCadastrados = await resp.json();
            } catch (e) { console.error(e); }
        }

        async function carregarExtrasGlobal() {
            try {
                const resp = await fetch('/api/horas-extras');
                extrasCadastrados = await resp.json();
            } catch (e) { console.error(e); }
        }

        async function carregarEscalaFuncionario(filial, matricula) {
            try {
                // Primeiro pegamos o funcionário para ver sua escala
                const respFunc = await fetch(`/api/funcionarios`);
                const funcs = await respFunc.json();
                const func = funcs.find(f => f.matricula === matricula && f.filial === filial);
                
                if (func) {
                    funcionarioSelecionado = func;
                    // Buscar o horário para ter a carga base
                    if (func.idHorario) {
                        const respH = await fetch(`/api/horarios`);
                        const horarios = await respH.json();
                        horarioFuncionario = horarios.find(h => h.id === func.idHorario);
                        
                        if (horarioFuncionario) {
                            document.getElementById('horario-info').style.display = 'block';
                            document.getElementById('horario-descricao').innerText = horarioFuncionario.descricao;
                        }
                    }

                    // Buscar a escala vinculada ao funcionário
                    const respE = await fetch(`/api/escalas`);
                    const escalas = await respE.json();
                    
                    if (func.idEscala) {
                        escalaFuncionario = escalas.find(e => e.id === func.idEscala);
                    }
                    
                    // Fallback caso não tenha idEscala ou não encontrou
                    if (!escalaFuncionario && func.idHorario) {
                        escalaFuncionario = escalas.find(e => e.filial === filial && e.idHorario === func.idHorario);
                    }
                }
            } catch (e) { console.error('Erro ao carregar escala/horário:', e); }
        }

        async function abrirModalSelecao() {
            if (!modalSelecao) modalSelecao = new bootstrap.Modal(document.getElementById('modalSelecao'));
            
            try {
                const resp = await fetch('/api/funcionarios');
                funcionariosEquipe = await resp.json();
                renderizarListaFunc(funcionariosEquipe);
                modalSelecao.show();
            } catch (e) {
                console.error('Erro ao carregar equipe:', e);
                alert('Erro ao carregar lista de funcionários');
            }
        }

        function renderizarListaFunc(lista) {
            const tbody = document.getElementById('lista-funcionarios');
            tbody.innerHTML = '';
            lista.forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f.filial}</td>
                    <td>${f.matricula}</td>
                    <td class="fw-bold">${f.nome}</td>
                    <td><span class="badge bg-light text-dark">${f.departamento || '-'}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary" onclick="selecionarFuncionario('${f.filial}', '${f.matricula}')">
                            <i class="fas fa-check me-1"></i> Selecionar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filtrarListaFunc() {
            const termo = document.getElementById('filtro-func').value.toLowerCase();
            const filtrados = funcionariosEquipe.filter(f => 
                f.nome.toLowerCase().includes(termo) || 
                f.matricula.includes(termo) || 
                (f.departamento && f.departamento.toLowerCase().includes(termo))
            );
            renderizarListaFunc(filtrados);
        }

        function selecionarFuncionario(filial, matricula) {
            const url = new URL(window.location.href);
            url.searchParams.set('filial', filial);
            url.searchParams.set('matricula', matricula);
            window.location.href = url.toString();
        }

        function getStatusDia(dataIso) {
            const data = new Date(dataIso + 'T00:00:00');
            const diaSemana = data.getDay();
            
            // Busca feriado na lista dinâmica do banco
            const feriado = feriadosCadastrados.find(f => f.data === dataIso);

            if (feriado) return { icone: 'fa-holly-berry', class: 'status-feriado', label: `Feriado: ${feriado.descricao}` };
            if (diaSemana === 0) return { icone: 'fa-mug-hot', class: 'status-domingo', label: 'Domingo' };
            if (diaSemana === 6) return { icone: 'fa-umbrella-beach', class: 'status-sabado', label: 'Sábado' };
            return { icone: 'fa-briefcase', class: 'status-util', label: 'Dia Útil' };
        }

        let modalManual;
        let acaoAtual = 'incluir';

        function prepararAcao(acao) {
            acaoAtual = acao;
            const titulo = document.querySelector('.modal-title');
            const btnSalvar = document.getElementById('btnSalvar');
            const camposHora = ['m-e1', 'm-s1', 'm-e2', 'm-s2'];
            const campoMatricula = document.getElementById('m-matricula');
            const campoFilial = document.getElementById('m-filial');

            if (!modalManual) modalManual = new bootstrap.Modal(document.getElementById('modalManual'));
            document.getElementById('formManual').reset();

            if (acao === 'incluir') {
                titulo.innerText = 'Nova Marcação Manual (Incremental)';
                btnSalvar.innerText = 'Salvar Marcação';
                btnSalvar.className = 'btn-plugin btn-plugin-primary';
                camposHora.forEach(id => document.getElementById(id).disabled = false);
                campoMatricula.disabled = false;
                campoFilial.disabled = false;
            } else if (acao === 'alterar') {
                titulo.innerText = 'Alterar Marcação Existente';
                btnSalvar.innerText = 'Confirmar Alteração';
                btnSalvar.className = 'btn-plugin btn-plugin-primary';
                camposHora.forEach(id => document.getElementById(id).disabled = false);
                campoMatricula.disabled = false;
                campoFilial.disabled = false;
            } else if (acao === 'excluir') {
                titulo.innerText = 'Excluir Marcação do Dia';
                btnSalvar.innerText = 'Excluir Definitivamente';
                btnSalvar.className = 'btn-plugin btn-plugin-primary bg-danger';
                // No caso de excluir, os horários não importam, apenas Matrícula e Data
                camposHora.forEach(id => document.getElementById(id).disabled = true);
                campoMatricula.disabled = false;
                campoFilial.disabled = false;
            } else if (acao === 'abonar') {
                prepararAbono();
                return; // O modal de abono é separado
            }

            modalManual.show();
        }

        function toggleAbonoHoras() {
            const diaTodo = document.getElementById('a-diatodo').checked;
            document.getElementById('div-horas-abono').style.display = diaTodo ? 'none' : 'block';
        }

        async function carregarOpcoesAbono(filial) {
            try {
                const resp = await fetch(`/api/abonos?filial=${filial}`);
                const abonos = await resp.json();
                const select = document.getElementById('a-abono');
                select.innerHTML = '<option value="">Selecione o motivo...</option>';
                abonos.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.id;
                    opt.dataset.anexo = a.anexo;
                    opt.textContent = `${a.codigo} - ${a.descricao}`;
                    select.appendChild(opt);
                });

                select.onchange = function() {
                    const sel = select.options[select.selectedIndex];
                    const exigeAnexo = sel.dataset.anexo === 'SIM';
                    document.getElementById('div-anexo').style.display = exigeAnexo ? 'block' : 'none';
                };
            } catch (e) {
                console.error('Erro ao carregar abonos:', e);
            }
        }

        let modalAbono;
        async function prepararAbono() {
            const urlParams = new URLSearchParams(window.location.search);
            const respMe = await fetch('/api/auth/me');
            const userMe = await respMe.json();
            const filialUrl = urlParams.get('filial') || userMe.filial || '001';

            if (!modalAbono) modalAbono = new bootstrap.Modal(document.getElementById('modalAbono'));
            document.getElementById('formAbono').reset();
            toggleAbonoHoras();
            
            await carregarOpcoesAbono(filialUrl);
            modalAbono.show();
        }

        async function salvarAbono() {
            const urlParams = new URLSearchParams(window.location.search);
            const respMe = await fetch('/api/auth/me');
            const userMe = await respMe.json();
            
            const filial = urlParams.get('filial') || userMe.filial || '001';
            const matricula = urlParams.get('matricula') || userMe.matricula || '000001';
            
            const dados = {
                filial: filial,
                matricula: matricula,
                data: document.getElementById('a-data').value,
                idAbono: document.getElementById('a-abono').value,
                abonoDiaTodo: document.getElementById('a-diatodo').checked,
                horasAbonadas: document.getElementById('a-horas').value,
                justificativa: document.getElementById('a-justificativa').value
            };

            if (!dados.data || !dados.idAbono) {
                alert('Data e motivo do abono são obrigatórios!');
                return;
            }

            const selAbono = document.getElementById('a-abono');
            const exigeAnexo = selAbono.options[selAbono.selectedIndex].dataset.anexo === 'SIM';
            const arquivo = document.getElementById('a-arquivo').files[0];

            if (exigeAnexo && !arquivo) {
                alert('O anexo do documento é obrigatório para este tipo de abono!');
                return;
            }

            if (!dados.abonoDiaTodo && !validarHora(dados.horasAbonadas)) {
                alert('Horário de abono inválido! Use HH:mm.');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('dados', JSON.stringify(dados));
                if (arquivo) {
                    formData.append('arquivo', arquivo);
                }

                const response = await fetch('/api/marcacoes/abonar', {
                    method: 'POST',
                    body: formData
                });

                const resData = await response.json();
                if (response.ok) {
                    if (resData.status === 'EM_APROVACAO') {
                        alert(resData.message);
                    }
                    modalAbono.hide();
                    carregarMarcacoes();
                } else {
                    alert('Erro ao salvar abono.');
                }
            } catch (e) {
                console.error(e);
            }
        }

        function validarHora(hora) {
            if (!hora) return true;
            const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            return regex.test(hora);
        }

        async function salvarManual() {
            const matricula = document.getElementById('m-matricula').value;
            const data = document.getElementById('m-data').value;

            if (!data || !matricula) {
                alert('Matrícula e Data são obrigatórios!');
                return;
            }

            const dados = {
                filial: document.getElementById('m-filial').value,
                matricula: matricula,
                data: data,
                e1: document.getElementById('m-e1').value,
                s1: document.getElementById('m-s1').value,
                e2: document.getElementById('m-e2').value,
                s2: document.getElementById('m-s2').value,
                origem: 'M'
            };

            const horas = ['e1', 's1', 'e2', 's2'];
            for (let h of horas) {
                if (!validarHora(dados[h])) {
                    alert(`Horário ${h.toUpperCase()} inválido! Use HH:mm.`);
                    return;
                }
            }

            // Tentar capturar localização para marcação manual também
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        dados.latitude = position.coords.latitude;
                        dados.longitude = position.coords.longitude;
                        enviarDadosManual(dados);
                    },
                    (error) => {
                        console.warn('Localização não capturada para manual:', error);
                        enviarDadosManual(dados);
                    },
                    { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 }
                );
            } else {
                enviarDadosManual(dados);
            }
        }

        async function enviarDadosManual(dados) {
            const matricula = dados.matricula;
            const data = dados.data;
            try {
                if (acaoAtual === 'excluir') {
                    if (confirm(`Tem certeza que deseja excluir a marcação da matrícula ${matricula} no dia ${data}?`)) {
                        const response = await fetch(`/api/marcacoes/matricula/${matricula}/data/${data}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            const resData = await response.json();
                            if (resData.status === 'EM_APROVACAO') {
                                alert(resData.message);
                            }
                            modalManual.hide();
                            carregarMarcacoes();
                        } else { 
                            const errorText = await response.text();
                            alert('Erro ao excluir: ' + errorText); 
                        }
                    }
                    return;
                }

                // Para incluir/alterar usamos o mesmo POST, pois o backend já faz o merge
                const response = await fetch('/api/marcacoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const resData = await response.json();
                if (response.ok) {
                    const msg = resData.message || 'Operação realizada com sucesso!';
                    
                    // Feedback visual moderno para manual
                    document.body.insertAdjacentHTML('beforeend', `
                        <div id="sucesso-manual" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
                            <div class="alert alert-primary shadow-lg border-0 d-flex align-items-center p-3" style="border-radius: 0.75rem; background: #6366f1; color: white;">
                                <i class="fas fa-info-circle me-2"></i>
                                <span class="small fw-bold">${msg}</span>
                            </div>
                        </div>
                    `);

                    modalManual.hide();
                    setTimeout(() => {
                        const el = document.getElementById('sucesso-manual');
                        if (el) el.remove();
                        carregarMarcacoes();
                    }, 2000);
                } else {
                    alert('Erro ao salvar marcação: ' + (resData.message || 'Erro desconhecido'));
                }
            } catch (error) { 
                console.error('Erro:', error); 
                alert('Erro ao processar requisição.');
            }
        }

        async function carregarFiliais() {
            try {
                const resp = await fetch('/api/filiais');
                const filiais = await resp.json();
                const select = document.getElementById('m-filial');
                if (select) {
                    select.innerHTML = '<option value="">Selecione...</option>';
                    filiais.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.codFilial;
                        opt.textContent = `${f.codFilial} - ${f.nome}`;
                        select.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar filiais:', error);
            }
        }

        async function carregarMarcacoes() {
            try {
            let userMe = null;
            try {
                const respMe = await fetch('/api/auth/me');
                userMe = await respMe.json();
            } catch (e) { console.error(e); }

            if (userMe && userMe.autenticado && (userMe.perfil === 'GESTOR' || userMe.perfil === 'ADMIN')) {
                document.getElementById('btn-trocar-funcionario').style.display = 'inline-flex';
                document.getElementById('btn-calcular-folha').style.display = 'inline-flex';
            }

            const urlParams = new URLSearchParams(window.location.search);
            const filialUrl = urlParams.get('filial') || (userMe ? userMe.filial : '001') || '001';
            const matriculaUrl = urlParams.get('matricula') || (userMe ? userMe.matricula : '000001') || '000001';
            
            document.getElementById('matricula-exibicao').innerText = `FILIAL: ${filialUrl} | MATRÍCULA: ${matriculaUrl}`;
            
            // Preenche os campos do modal manual mas não os bloqueia
            const mFilial = document.getElementById('m-filial');
            const mMatricula = document.getElementById('m-matricula');
            
            if (mFilial) mFilial.value = filialUrl;
            if (mMatricula) mMatricula.value = matriculaUrl;

            // Carregar aprovações pendentes para este funcionário
            await carregarAprovacoesPendentes(matriculaUrl);

            // Carregar dados do horário do funcionário
            try {
                // Ao carregar marcações, já buscamos escala e horário
                await carregarEscalaFuncionario(filialUrl, matriculaUrl);
            } catch (e) {
                console.error('Erro ao buscar escala/horário do funcionário:', e);
            }

                // 0. Carregar Feriados primeiro
                const respF = await fetch('/api/marcacoes/feriados');
                feriadosCadastrados = await respF.json();

                // 1. Carregar o Período Ativo
                const respPeriodo = await fetch(`/api/marcacoes/periodo?filial=${filialUrl}`);
                if (respPeriodo.status === 204) {
                    document.getElementById('periodo-info').innerText = 'Nenhum período ativo';
                    return;
                }
                const periodo = await respPeriodo.json();
                
                if (!periodo) {
                    document.getElementById('periodo-info').innerText = 'Nenhum período ativo';
                    return;
                }

                const dataInicio = new Date(periodo.dataInicio + 'T00:00:00');
                const dataFim = new Date(periodo.dataFim + 'T00:00:00');
                
                document.getElementById('periodo-info').innerHTML = 
                    `<i class="fas fa-calendar-days me-2 text-muted"></i> Período: <strong>${dataInicio.toLocaleDateString('pt-BR')}</strong> até <strong>${dataFim.toLocaleDateString('pt-BR')}</strong>`;

                // 2. Carregar as Marcações Reais FILTRADAS POR FILIAL E MATRÍCULA
                const respMarcacoes = await fetch(`/api/marcacoes?filial=${filialUrl}&matricula=${matriculaUrl}`);
                const marcacoesExistentes = await respMarcacoes.json();

                // Criar um mapa para facilitar a busca por data
                const mapaMarcacoes = {};
                marcacoesExistentes.forEach(m => {
                    mapaMarcacoes[m.data] = m;
                });

                // 3. Gerar as linhas para TODOS os dias do período
                const tbody = document.getElementById('tabela-marcacoes');
                tbody.innerHTML = '';

                let dataAtual = new Date(dataInicio);
                while (dataAtual <= dataFim) {
                    const dataIso = dataAtual.toISOString().split('T')[0];
                    const marcacao = mapaMarcacoes[dataIso];
                    const status = getStatusDia(dataIso);

                    const aprovacao = aprovacoesPendentes.find(a => a.dataMarcacao === dataIso);

                    const tr = document.createElement('tr');
                    if (status.label !== 'Dia Útil') tr.style.backgroundColor = '#fcfcfc';
                    if (marcacao && marcacao.idAbono) tr.style.backgroundColor = 'rgba(14, 165, 233, 0.08)';
                    if (aprovacao) {
                        if (aprovacao.status === "EM_EFETIVACAO") {
                            tr.style.backgroundColor = 'rgba(99, 102, 241, 0.1)'; // Azulado para efetivação
                        } else {
                            tr.style.backgroundColor = 'rgba(245, 158, 11, 0.1)'; // Cor de alerta para pendente
                        }
                    }

                    let abonoTexto = '-';
                    if (marcacao && marcacao.idAbono) {
                        const abonoInfo = abonosCadastrados.find(a => a.id == marcacao.idAbono);
                        if (abonoInfo) {
                            let tooltipDesc = `${abonoInfo.codigo} - ${abonoInfo.descricao} ${marcacao.abonoDiaTodo ? '(DIA TODO)' : '(' + marcacao.horasAbonadas + ')'}`;
                            if (marcacao.justificativa) tooltipDesc += ` | Justificativa: ${marcacao.justificativa}`;
                            
                            let linkAnexo = '';
                            if (marcacao.anexoNome) {
                                // Se for gestor ou admin, permite ver/baixar
                                if (userMe.perfil === 'GESTOR' || userMe.perfil === 'ADMIN') {
                                    linkAnexo = `<div class="mt-1">
                                        <a href="/api/aprovacoes/arquivo/view/${marcacao.anexoNome}" target="_blank" class="btn btn-xs btn-link p-0" style="font-size: 0.65rem;">
                                            <i class="fas fa-eye me-1"></i>Ver Documento
                                        </a>
                                    </div>`;
                                }
                            }

                            abonoTexto = `<span class="text-info" title="${tooltipDesc}" style="cursor: help; font-size: 1rem;" data-bs-toggle="tooltip" data-bs-placement="top">
                                <i class="fas fa-file-circle-check"></i>
                            </span>${linkAnexo}`;
                        }
                    } else if (aprovacao && aprovacao.tipo === 'ABONO') {
                        let tooltipAprov = "Abono em aprovação";
                        if (aprovacao.justificativa) tooltipAprov += ` | Justificativa: ${aprovacao.justificativa}`;
                        
                        let linkAnexoAprov = '';
                        if (aprovacao.anexoNome) {
                            if (userMe.perfil === 'GESTOR' || userMe.perfil === 'ADMIN') {
                                linkAnexoAprov = `<div class="mt-1">
                                    <a href="/api/aprovacoes/arquivo/view/${aprovacao.anexoNome}" target="_blank" class="btn btn-xs btn-link p-0" style="font-size: 0.65rem;">
                                        <i class="fas fa-eye me-1"></i>Ver Anexo Pend.
                                    </a>
                                </div>`;
                            }
                        }

                        abonoTexto = `<span class="text-warning" title="${tooltipAprov}" style="cursor: help; font-size: 1rem;" data-bs-toggle="tooltip" data-bs-placement="top">
                            <i class="fas fa-file-circle-exclamation"></i>
                        </span>${linkAnexoAprov}`;
                    }

                    const displayE1 = (aprovacao && aprovacao.e1) ? `<span class="text-warning">${aprovacao.e1}*</span>` : (marcacao ? (marcacao.e1 || '') : '');
                    const displayS1 = (aprovacao && aprovacao.s1) ? `<span class="text-warning">${aprovacao.s1}*</span>` : (marcacao ? (marcacao.s1 || '') : '');
                    const displayE2 = (aprovacao && aprovacao.e2) ? `<span class="text-warning">${aprovacao.e2}*</span>` : (marcacao ? (marcacao.e2 || '') : '');
                    const displayS2 = (aprovacao && aprovacao.s2) ? `<span class="text-warning">${aprovacao.s2}*</span>` : (marcacao ? (marcacao.s2 || '') : '');
                    
                    let origemBadge = '';
                    if (aprovacao) {
                        let statusAprov = "EM APROV.";
                        let colorClass = "bg-warning";
                        if (aprovacao.status === "EM_EFETIVACAO") {
                            statusAprov = "EM EFETIV.";
                            colorClass = "bg-info";
                        }
                        origemBadge = `<span class="badge ${colorClass} text-dark border-0 shadow-sm px-2" title="Aguardando Aprovação: ${aprovacao.tipo}">${statusAprov}</span>`;
                    } else if (marcacao) {
                        let colorClass = marcacao.origem === 'M' ? 'bg-warning' : (marcacao.origem === 'A' ? 'bg-success text-white' : 'bg-white text-muted');
                        origemBadge = `<span class="badge ${colorClass} border-0 shadow-sm px-2">
                                ${marcacao.origem || ''}
                            </span>`;
                    }

                    tr.innerHTML = `
                        <td class="text-center">
                            <div class="icon-status ${status.class} mx-auto" style="width: 32px; height: 32px;">
                                <i class="fas ${status.icone}" style="font-size: 14px;" title="${status.label}"></i>
                            </div>
                        </td>
                        <td>${marcacao ? (marcacao.filial || '-') : (aprovacao ? aprovacao.filial : '-')}</td>
                        <td>${marcacao ? (marcacao.matricula || '-') : (aprovacao ? aprovacao.matricula : '-')}</td>
                        <td class="fw-bold">${dataAtual.toLocaleDateString('pt-BR')}</td>
                        <td class="text-primary fw-bold">${displayE1}</td>
                        <td class="text-primary fw-bold">${displayS1}</td>
                        <td class="text-primary fw-bold">${displayE2}</td>
                        <td class="text-primary fw-bold">${displayS2}</td>
                        <td>
                            ${marcacao && marcacao.latitude ? `
                                <a href="https://www.google.com/maps?q=${marcacao.latitude},${marcacao.longitude}" target="_blank" class="text-decoration-none text-primary" title="${marcacao.endereco || 'Ver localização'}">
                                    <i class="fas fa-location-dot" style="font-size: 1.1rem;"></i>
                                </a>
                            ` : '-'}
                        </td>
                        <td class="text-center">
                            ${origemBadge}
                        </td>
                        <td>${abonoTexto}</td>
                    `;
                    tbody.appendChild(tr);

                // Avançar um dia
                dataAtual.setDate(dataAtual.getDate() + 1);
            }

            // Inicializa tooltips do Bootstrap para toda a tabela após o loop
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        } catch (error) {
                console.error('Erro ao processar marcações:', error);
                document.getElementById('periodo-info').innerText = 'Erro ao carregar dados';
            }
        }

        // Funções de Cálculo de Horas
        function hparaMin(h) {
            if (!h) return null;
            const [hrs, min] = h.split(':').map(Number);
            return (hrs * 60) + min;
        }

        function minParaH(m) {
            if (m === null || m < 0) return '00:00';
            const hrs = Math.floor(m / 60);
            const min = m % 60;
            return `${hrs.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
        }

        function calcularTotaisFuncionario(marcacoes, escala, horario) {
            let totalTrabalhado = 0;
            let totalAlmoco = 0;
            let totalAbonado = 0;
            let extras = {};

            if (!escala) return null;

            marcacoes.forEach(m => {
                let trabalhadasNoDia = 0;
                let abonadasNoDia = 0;
                let almocoMin = 0;

                if (m.idAbono) {
                    let abonoMin = 0;
                    if (m.abonoDiaTodo) {
                        if (horario) {
                            const he1 = hparaMin(horario.e1);
                            const hs1 = hparaMin(horario.s1);
                            const he2 = hparaMin(horario.e2);
                            const hs2 = hparaMin(horario.s2);
                            if (he1 !== null && hs2 !== null) {
                                let hAlmoco = 0;
                                if (hs1 !== null && he2 !== null) hAlmoco = he2 - hs1;
                                abonoMin = (hs2 - he1) - hAlmoco;
                            }
                        }
                    } else if (m.horasAbonadas) {
                        abonoMin = hparaMin(m.horasAbonadas);
                    }
                    abonadasNoDia = abonoMin;
                }

                const e1 = hparaMin(m.e1);
                const s1 = hparaMin(m.s1);
                const e2 = hparaMin(m.e2);
                const s2 = hparaMin(m.s2);

                let trabalhadoReal = 0;
                if (e1 !== null && s1 !== null) trabalhadoReal += (s1 - e1);
                if (e2 !== null && s2 !== null) trabalhadoReal += (s2 - e2);
                if (trabalhadoReal === 0 && e1 !== null && s2 !== null) trabalhadoReal = (s2 - e1);

                if (trabalhadoReal > 0) {
                    trabalhadasNoDia = trabalhadoReal;
                    if (s1 !== null && e2 !== null) almocoMin = (e2 - s1);
                }

                const totalDiaMin = trabalhadasNoDia + abonadasNoDia;
                if (totalDiaMin > 0) {
                    totalTrabalhado += trabalhadasNoDia;
                    totalAbonado += abonadasNoDia;
                    totalAlmoco += almocoMin;

                    const dateObj = new Date(m.data + 'T00:00:00');
                    const diasSemanaArr = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                    const diaNome = diasSemanaArr[dateObj.getDay()];
                    const tipoDia = escala[diaNome];
                    const extraField = diaNome.substring(0, 3) + 'Extra';
                    let percExtra = escala[extraField];

                    let cargaPrevista = 0;
                    if (tipoDia === 'Útil') {
                        if (!percExtra) percExtra = '050%';
                        if (horario) {
                            const hE1 = hparaMin(horario.e1);
                            const hS1 = hparaMin(horario.s1);
                            const hE2 = hparaMin(horario.e2);
                            const hS2 = hparaMin(horario.s2);
                            if (hE1 !== null && hS2 !== null) {
                                cargaPrevista = (hS2 - hE1) - ((hS1 !== null && hE2 !== null) ? (hE2 - hS1) : 0);
                            }
                        }
                    } else {
                        if (!percExtra) percExtra = '100%';
                        cargaPrevista = 0;
                    }

                    if (totalDiaMin > cargaPrevista) {
                        const minutosExtra = totalDiaMin - cargaPrevista;
                        if (!extras[percExtra]) extras[percExtra] = 0;
                        extras[percExtra] += minutosExtra;
                    }
                }
            });

            return {
                totalTrabalhado: minParaH(totalTrabalhado),
                totalAlmoco: minParaH(totalAlmoco),
                totalAbonado: minParaH(totalAbonado),
                extras: extras
            };
        }

        async function calcularFolha() {
            const tipo = document.querySelector('input[name="tipoCalculo"]:checked').value;
            const container = document.getElementById('resultado-calculo');
            const btnExtrair = document.getElementById('btn-extrair-txt');
            const divProg = document.getElementById('div-progresso');
            const barra = document.getElementById('barra-progresso');
            const labelProg = document.getElementById('label-progresso');

            btnExtrair.style.display = 'none';
            container.innerHTML = '';
            divProg.style.display = 'none';
            dadosLoteExport = [];

            if (tipo === 'individual') {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    let mUrl = urlParams.get('matricula');
                    let fUrl = urlParams.get('filial');

                    if (!mUrl) {
                        const rMe = await fetch('/api/auth/me');
                        const uMe = await rMe.json();
                        mUrl = uMe.matricula;
                        fUrl = uMe.filial;
                    }

                    const response = await fetch(`/api/marcacoes?filial=${fUrl}&matricula=${mUrl}`);
                    const marcacoes = await response.json();
                    await carregarEscalaFuncionario(fUrl, mUrl);

                    if (!escalaFuncionario) {
                        alert("Escala não cadastrada");
                        return;
                    }

                    const diasS = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'];
                    let hasHE = false;
                    for (let d of diasS) {
                        if (escalaFuncionario[d.substring(0,3) + 'Extra']) { hasHE = true; break; }
                    }
                    if (!hasHE) { alert("Horas Extras não informado na escala"); return; }

                    let totalTrabG = 0, totalAlmG = 0, totalAbonG = 0;
                    let extrasP = {};

                    marcacoes.sort((a,b) => a.data.localeCompare(b.data)).forEach(m => {
                        let totalD = 0, trabD = 0, abonD = 0, almD = 0;
                        let isAb = false;

                        if (m.idAbono) {
                            isAb = true;
                            let abMin = 0;
                            if (m.abonoDiaTodo && horarioFuncionario) {
                                const he1 = hparaMin(horarioFuncionario.e1), hs1 = hparaMin(horarioFuncionario.s1);
                                const he2 = hparaMin(horarioFuncionario.e2), hs2 = hparaMin(horarioFuncionario.s2);
                                if (he1 !== null && hs2 !== null) abMin = (hs2 - he1) - (hs1 !== null && he2 !== null ? (he2 - hs1) : 0);
                            } else if (m.horasAbonadas) abMin = hparaMin(m.horasAbonadas);
                            abonD = abMin;
                        }

                        const e1 = hparaMin(m.e1), s1 = hparaMin(m.s1);
                        const e2 = hparaMin(m.e2), s2 = hparaMin(m.s2);
                        let trReal = 0;
                        if (e1 !== null && s1 !== null) trReal += (s1 - e1);
                        if (e2 !== null && s2 !== null) trReal += (s2 - e2);
                        if (trReal === 0 && e1 !== null && s2 !== null) trReal = (s2 - e1);

                        if (trReal > 0) {
                            trabD = trReal;
                            if (s1 !== null && e2 !== null) almD = (e2 - s1);
                        }

                        totalD = trabD + abonD;
                        if (totalD > 0) {
                            totalTrabG += trabD; totalAbonG += abonD; totalAlmG += almD;
                            let heT = '';
                            const dObj = new Date(m.data + 'T00:00:00');
                            const dNome = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][dObj.getDay()];
                            const tDia = escalaFuncionario[dNome];
                            let pExtra = escalaFuncionario[dNome.substring(0,3) + 'Extra'];
                            let cPrev = 0;

                            if (tDia === 'Útil') {
                                if (!pExtra) pExtra = '050%';
                                if (horarioFuncionario) {
                                    const hE1 = hparaMin(horarioFuncionario.e1), hS1 = hparaMin(horarioFuncionario.s1);
                                    const hE2 = hparaMin(horarioFuncionario.e2), hS2 = hparaMin(horarioFuncionario.s2);
                                    if (hE1 !== null && hS2 !== null) cPrev = (hS2 - hE1) - (hS1 !== null && hE2 !== null ? (hE2 - hS1) : 0);
                                }
                            } else { if (!pExtra) pExtra = '100%'; cPrev = 0; }

                            if (totalD > cPrev) {
                                const mEx = totalD - cPrev;
                                if (!extrasP[pExtra]) extrasP[pExtra] = 0;
                                extrasP[pExtra] += mEx;
                                heT = `<div class="text-danger fw-bold" style="font-size: 0.7rem;">HE: ${minParaH(mEx)} (${pExtra})</div>`;
                            }

                            const item = document.createElement('div');
                            item.className = 'list-group-item list-group-item-action py-2 px-0 border-0 border-bottom';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between align-items-center px-2">
                                    <div>
                                        <h6 class="mb-0 fw-bold text-dark" style="font-size: 0.85rem;">${new Date(m.data + 'T00:00:00').toLocaleDateString('pt-BR')}</h6>
                                        <small class="text-muted" style="font-size: 0.7rem;"><i class="fas fa-utensils me-1"></i> Almoço: ${minParaH(almD)}</small>
                                        ${heT}
                                    </div>
                                    <div class="text-end">
                                        <span class="badge ${isAb ? 'bg-info' : 'bg-primary'} px-2 py-1" style="font-size: 0.8rem;">${minParaH(totalD)}</span>
                                        <div class="small text-muted mt-1" style="font-size: 0.65rem;">${isAb ? 'ABONADAS' : 'TRABALHADAS'}</div>
                                    </div>
                                </div>`;
                            container.appendChild(item);
                        }
                    });

                    document.getElementById('total-trabalhado').innerText = minParaH(totalTrabG);
                    document.getElementById('total-almoco').innerText = minParaH(totalAlmG);
                    document.getElementById('total-abonado').innerText = minParaH(totalAbonG);
                    document.getElementById('label-total-trabalhado').innerText = (totalTrabG > 0 && marcacoes.some(m => m.idAbono)) ? 'Total Geral' : 'Total Trab.';

                    window.dadosCalculadosParaExport = {
                        totalTrabalhado: minParaH(totalTrabG),
                        totalAlmoco: minParaH(totalAlmG),
                        totalAbonado: minParaH(totalAbonG),
                        extras: extrasP
                    };
                    btnExtrair.innerHTML = '<i class="fas fa-file-export me-1"></i>Baixar Individual (.TXT)';
                    btnExtrair.style.display = 'block';

                } catch (e) { console.error(e); }
            } else {
                // Lote ou Depto
                try {
                    container.innerHTML = '<div class="text-center py-4 text-primary"><div class="spinner-border spinner-border-sm me-2"></div>Processando equipe...</div>';
                    const [rEsc, rHor, rFun] = await Promise.all([ fetch('/api/escalas'), fetch('/api/horarios'), fetch('/api/funcionarios') ]);
                    const escalas = await rEsc.json(), horarios = await rHor.json();
                    let funcs = await rFun.json();

                    if (tipo === 'depto') {
                        const depto = document.getElementById('calc-depto-select').value;
                        if (!depto) { alert("Selecione um departamento."); return; }
                        funcs = funcs.filter(f => f.departamento === depto);
                    }

                    divProg.style.display = 'block';
                    let total = funcs.length;

                    for (let i = 0; i < total; i++) {
                        let f = funcs[i];
                        labelProg.innerText = `Processando: ${i+1}/${total} (${f.nome})`;
                        barra.style.width = `${((i+1)/total)*100}%`;

                        const rM = await fetch(`/api/marcacoes?filial=${f.filial}&matricula=${f.matricula}`);
                        const marcacoes = await rM.json();
                        const escala = escalas.find(e => e.id === f.idEscala) || escalas.find(e => e.filial === f.filial && e.idHorario === f.idHorario);
                        const horario = horarios.find(h => h.id === f.idHorario);

                        if (escala) {
                            const totais = calcularTotaisFuncionario(marcacoes, escala, horario);
                            if (totais) {
                                dadosLoteExport.push({ matricula: f.matricula, nome: f.nome, dados: totais });
                            }
                        }
                    }

                    container.innerHTML = `
                        <div class="alert alert-success border-0 shadow-sm rounded-3 p-3">
                            <h6 class="fw-bold mb-1"><i class="fas fa-check-circle me-2"></i>Cálculo Concluído</h6>
                            <p class="small mb-0">Foram processados <strong>${dadosLoteExport.length}</strong> colaboradores com sucesso.</p>
                        </div>`;
                    btnExtrair.innerHTML = '<i class="fas fa-file-export me-1"></i>Baixar Lote (.TXT)';
                    btnExtrair.style.display = 'block';
                    divProg.style.display = 'none';

                } catch (e) { 
                    console.error(e); 
                    container.innerHTML = '<div class="alert alert-danger small">Erro ao processar lote.</div>';
                    divProg.style.display = 'none';
                }
            }
        }

        function extrairTXT() {
            const tipo = document.querySelector('input[name="tipoCalculo"]:checked').value;
            let conteudo = "";

            function formatarItem(d, mat, nom) {
                let s = `MATRICULA: ${mat} | NOME: ${nom}\n`;
                s += `HORAS TRABALHADAS ${d.totalTrabalhado.replace(':', ',')}\n`;
                s += `HORAS DE ALMOCO ${d.totalAlmoco.replace(':', ',')}\n`;
                s += `HORAS ABONADAS ${d.totalAbonado.replace(':', ',')}\n`;
                const percs = Object.keys(d.extras).sort();
                percs.forEach(p => {
                    s += `HORAS EXTRAS ${p} ${minParaH(d.extras[p]).replace(':', '.')}\n`;
                });
                s += `--------------------------------------------------\n`;
                return s;
            }

            if (tipo === 'individual') {
                const dados = window.dadosCalculadosParaExport;
                if (!dados) { alert('Calcule primeiro.'); return; }
                const matricula = document.getElementById('m-matricula').value;
                const nome = funcionarioSelecionado ? funcionarioSelecionado.nome : 'N/A';
                conteudo = formatarItem(dados, matricula, nome);
            } else {
                if (dadosLoteExport.length === 0) { alert('Nenhum dado de lote para exportar.'); return; }
                dadosLoteExport.forEach(item => {
                    conteudo += formatarItem(item.dados, item.matricula, item.nome);
                });
            }

            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `apontamento_${tipo}_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        window.onload = async () => {
            carregarFiliais();
            await carregarDepartamentos();
            await carregarAbonosGlobal();
            await carregarExtrasGlobal();
            carregarMarcacoes();
        };
    </script>
</body>
</html>
