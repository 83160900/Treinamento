<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin-RH | Extrair Horas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --plugin-primary: #6366f1;
            --plugin-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --text-dark: #0f172a;
            --text-muted: #64748b;
            --bg-glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            background: transparent;
            color: var(--text-dark);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            padding: 1rem;
        }

        .container-premium {
            max-width: 800px;
            margin: 0 auto;
        }

        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            background: var(--plugin-gradient);
            padding: 1rem 1.5rem;
            border-radius: 1.25rem;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.3);
        }

        .btn-plugin-primary {
            background: var(--plugin-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }

        .btn-plugin-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .form-control, .form-select {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--plugin-primary);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.1);
        }

        .filter-box {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container-premium">
        <div class="header-section">
            <div>
                <h2 class="fw-800 mb-1"><i class="fas fa-file-export me-2"></i>Extrair Horas</h2>
                <p class="text-white-50 small mb-0">Geração de relatórios de apontamento em lote ou departamento.</p>
            </div>
        </div>

        <div class="glass-card">
            <div class="filter-box">
                <h6 class="fw-800 text-muted mb-3"><i class="fas fa-filter me-2 text-primary"></i>CONFIGURAÇÃO DA EXTRAÇÃO</h6>
                
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label small fw-bold text-muted">TIPO DE FILTRO</label>
                        <div class="d-flex gap-4 p-2 border rounded-3 bg-light">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoExtrair" id="ext-lote" value="lote" checked onchange="toggleFiltro()">
                                <label class="form-check-label fw-bold" for="ext-lote">Lote Completo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoExtrair" id="ext-depto" value="depto" onchange="toggleFiltro()">
                                <label class="form-check-label fw-bold" for="ext-depto">Por Departamento</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoExtrair" id="ext-individual" value="individual" onchange="toggleFiltro()">
                                <label class="form-check-label fw-bold" for="ext-individual">Individual</label>
                            </div>
                        </div>
                    </div>

                    <div id="div-depto" class="col-md-12" style="display: none;">
                        <label class="form-label small fw-bold text-muted">DEPARTAMENTO</label>
                        <select id="sel-depto" class="form-select border-light-subtle">
                            <option value="">Selecione o departamento...</option>
                        </select>
                    </div>

                    <div id="div-individual" class="col-md-12" style="display: none;">
                        <label class="form-label small fw-bold text-muted">COLABORADOR</label>
                        <select id="sel-colaborador" class="form-select border-light-subtle">
                            <option value="">Selecione o colaborador...</option>
                        </select>
                    </div>

                    <div class="col-md-12 mt-4">
                        <button class="btn-plugin-primary w-100 py-3" onclick="processar()">
                            <i class="fas fa-wand-magic-sparkles me-2"></i>PROCESSAR E BAIXAR .TXT
                        </button>
                    </div>
                </div>
            </div>

            <div id="div-progresso" style="display: none;">
                <div class="progress mb-2" style="height: 12px; border-radius: 6px;">
                    <div id="barra-progresso" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="label-progresso" class="text-center text-muted fw-bold small">Iniciando processamento...</p>
            </div>

            <div id="resultado" class="mt-3"></div>
        </div>
    </div>

    <script>
        let feriados = [], abonos = [], escalas = [], horarios = [];

        function hparaMin(h) {
            if (!h) return null;
            const [hrs, min] = h.split(':').map(Number);
            return (hrs * 60) + min;
        }

        function minParaH(m) {
            if (m === null || m < 0) return '00:00';
            const hrs = Math.floor(m / 60);
            const min = m % 60;
            return `${hrs.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
        }

        async function carregarDependencias() {
            try {
                const [rF, rA, rE, rH, rD, rFun] = await Promise.all([
                    fetch('/api/marcacoes/feriados'),
                    fetch('/api/abonos'),
                    fetch('/api/escalas'),
                    fetch('/api/horarios'),
                    fetch('/api/departamentos'),
                    fetch('/api/funcionarios')
                ]);
                feriados = await rF.json();
                abonos = await rA.json();
                escalas = await rE.json();
                horarios = await rH.json();
                
                const deptos = await rD.json();
                const selD = document.getElementById('sel-depto');
                deptos.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.nome;
                    opt.textContent = `${d.filial} - ${d.nome}`;
                    selD.appendChild(opt);
                });

                const funcs = await rFun.json();
                const selF = document.getElementById('sel-colaborador');
                funcs.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = JSON.stringify({filial: f.filial, matricula: f.matricula, nome: f.nome});
                    opt.textContent = `${f.filial} - ${f.matricula} - ${f.nome}`;
                    selF.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        function toggleFiltro() {
            const tipo = document.querySelector('input[name="tipoExtrair"]:checked').value;
            document.getElementById('div-depto').style.display = (tipo === 'depto' ? 'block' : 'none');
            document.getElementById('div-individual').style.display = (tipo === 'individual' ? 'block' : 'none');
            document.getElementById('resultado').innerHTML = '';
        }

        function calcularTotais(mList, escala, horario) {
            let totalT = 0, totalA = 0, totalAb = 0, extras = {};
            if (!escala) return null;

            mList.forEach(m => {
                let trab = 0, abon = 0, alm = 0;
                if (m.idAbono) {
                    let abMin = 0;
                    if (m.abonoDiaTodo && horario) {
                        const he1 = hparaMin(horario.e1), hs1 = hparaMin(horario.s1);
                        const he2 = hparaMin(horario.e2), hs2 = hparaMin(horario.s2);
                        if (he1 !== null && hs2 !== null) abMin = (hs2 - he1) - (hs1 !== null && he2 !== null ? (he2 - hs1) : 0);
                    } else if (m.horasAbonadas) abMin = hparaMin(m.horasAbonadas);
                    abon = abMin;
                }
                const e1 = hparaMin(m.e1), s1 = hparaMin(m.s1), e2 = hparaMin(m.e2), s2 = hparaMin(m.s2);
                let trR = 0;
                if (e1 !== null && s1 !== null) trR += (s1 - e1);
                if (e2 !== null && s2 !== null) trR += (s2 - e2);
                if (trR === 0 && e1 !== null && s2 !== null) trR = (s2 - e1);
                if (trR > 0) { trab = trR; if (s1 !== null && e2 !== null) alm = (e2 - s1); }

                const totD = trab + abon;
                if (totD > 0) {
                    totalT += trab; totalAb += abon; totalA += alm;
                    const dObj = new Date(m.data + 'T00:00:00');
                    const dNome = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][dObj.getDay()];
                    const tDia = escala[dNome];
                    let pEx = escala[dNome.substring(0,3) + 'Extra'];
                    let cPr = 0;
                    if (tDia === 'Útil') {
                        if (!pEx) pEx = '050%';
                        if (horario) {
                            const hE1 = hparaMin(horario.e1), hS1 = hparaMin(horario.s1);
                            const hE2 = hparaMin(horario.e2), hS2 = hparaMin(horario.s2);
                            if (hE1 !== null && hS2 !== null) cPr = (hS2 - hE1) - (hS1 !== null && hE2 !== null ? (hE2 - hS1) : 0);
                        }
                    } else { if (!pEx) pEx = '100%'; cPr = 0; }
                    if (totD > cPr) {
                        const mEx = totD - cPr;
                        if (!extras[pEx]) extras[pEx] = 0;
                        extras[pEx] += mEx;
                    }
                }
            });
            return { totalTrabalhado: minParaH(totalT), totalAlmoco: minParaH(totalA), totalAbonado: minParaH(totalAb), extras: extras };
        }

        async function processar() {
            const tipo = document.querySelector('input[name="tipoExtrair"]:checked').value;
            let funcs = [];
            const rFunc = await fetch('/api/funcionarios');
            const allFuncs = await rFunc.json();

            if (tipo === 'lote') funcs = allFuncs;
            else if (tipo === 'depto') {
                const d = document.getElementById('sel-depto').value;
                if (!d) { alert("Selecione o departamento"); return; }
                funcs = allFuncs.filter(f => f.departamento === d);
            } else {
                const val = document.getElementById('sel-colaborador').value;
                if (!val) { alert("Selecione o colaborador"); return; }
                funcs = [JSON.parse(val)];
            }

            const divP = document.getElementById('div-progresso'), barra = document.getElementById('barra-progresso'), labelP = document.getElementById('label-progresso');
            divP.style.display = 'block';
            let conteudo = "", total = funcs.length;

            for (let i = 0; i < total; i++) {
                let f = funcs[i];
                labelP.innerText = `Processando ${i+1}/${total}: ${f.nome}`;
                barra.style.width = `${((i+1)/total)*100}%`;

                const respM = await fetch(`/api/marcacoes?filial=${f.filial}&matricula=${f.matricula}`);
                const mList = await respM.json();
                const esc = escalas.find(e => e.id === f.idEscala) || escalas.find(e => e.filial === f.filial && e.idHorario === f.idHorario);
                const hor = horarios.find(h => h.id === f.idHorario);

                if (esc) {
                    const res = calcularTotais(mList, esc, hor);
                    if (res) {
                        conteudo += `MATRICULA: ${f.matricula} | NOME: ${f.nome}\n`;
                        conteudo += `HORAS TRABALHADAS ${res.totalTrabalhado.replace(':', ',')}\n`;
                        conteudo += `HORAS DE ALMOCO ${res.totalAlmoco.replace(':', ',')}\n`;
                        conteudo += `HORAS ABONADAS ${res.totalAbonado.replace(':', ',')}\n`;
                        Object.keys(res.extras).sort().forEach(p => {
                            conteudo += `HORAS EXTRAS ${p} ${minParaH(res.extras[p]).replace(':', '.')}\n`;
                        });
                        conteudo += `--------------------------------------------------\n`;
                    }
                }
            }

            if (conteudo) {
                const blob = new Blob([conteudo], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `extracao_${tipo}_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                document.getElementById('resultado').innerHTML = `<div class="alert alert-success">Extração concluída para ${total} colaborador(es).</div>`;
            } else {
                document.getElementById('resultado').innerHTML = `<div class="alert alert-warning">Nenhum dado encontrado para extração.</div>`;
            }
            divP.style.display = 'none';
        }

        window.onload = carregarDependencias;
    </script>
</body>
</html>
