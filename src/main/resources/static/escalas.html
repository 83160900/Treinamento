<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin-RH | Gestão de Escalas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --plugin-primary: #6366f1;
            --plugin-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --text-dark: #0f172a;
            --text-muted: #64748b;
            --bg-glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            background: transparent;
            color: var(--text-dark);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            padding: 1rem;
        }

        .container-premium {
            max-width: 100%;
            margin: 0 auto;
        }

        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--plugin-gradient);
            padding: 1.25rem 2rem;
            border-radius: 1.25rem;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.3);
        }

        .btn-plugin-primary {
            background: var(--plugin-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }

        .btn-plugin-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .table-premium th {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 2px solid #f1f5f9;
            padding: 0.75rem 0.5rem;
            font-weight: 800;
            text-align: center;
        }

        .table-premium td {
            padding: 0.75rem 0.4rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
        }

        .badge-day {
            padding: 0.3rem 0.4rem;
            border-radius: 0.4rem;
            font-size: 0.65rem;
            display: inline-block;
            min-width: 70px;
        }

        .badge-util { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .badge-dsr { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .badge-comp { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }

        .form-control, .form-select {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--plugin-primary);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>
    <div class="container-premium">
        <div class="header-section">
            <div>
                <h2 class="fw-800 mb-1"><i class="fas fa-plug text-primary me-2"></i>Plugin-RH | Escalas</h2>
                <p class="text-white-50 small mb-0">Defina a escala semanal dos colaboradores.</p>
            </div>
            <button class="btn-plugin-primary" onclick="abrirModal()">
                <i class="fas fa-plus me-2"></i>Nova Escala
            </button>
        </div>

        <div class="glass-card">
            <div class="table-responsive">
                <table class="table table-premium mb-0">
                    <thead>
                        <tr>
                            <th>Filial</th>
                            <th>Código</th>
                            <th>Horário</th>
                            <th>SEG</th>
                            <th>TER</th>
                            <th>QUA</th>
                            <th>QUI</th>
                            <th>SEX</th>
                            <th>SÁB</th>
                            <th>DOM</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lista-escalas">
                        <!-- Conteúdo Dinâmico -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro -->
    <div class="modal fade" id="modalEscala" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1.25rem;">
                <div class="modal-header border-bottom p-4">
                    <h5 class="modal-title fw-800"><i class="fas fa-calendar-week me-2 text-primary"></i>Configurar Escala Semanal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formEscala">
                        <input type="hidden" id="e-id">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">Filial</label>
                                <select id="e-filial" class="form-select border-light-subtle" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">Código</label>
                                <input type="text" id="e-codigo" class="form-control" placeholder="001" maxlength="3" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">Horário Base</label>
                                <select id="e-horario" class="form-select border-light-subtle" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">Cerca Virtual</label>
                                <select id="e-cerca" class="form-select border-light-subtle" onchange="toggleCerca()">
                                    <option value="false">NÃO</option>
                                    <option value="true">SIM</option>
                                </select>
                            </div>
                            <div id="div-raio" class="col-md-8" style="display: none;">
                                <label class="form-label small fw-bold text-muted">Raio de Alcance (metros) - Máx 1000m</label>
                                <div class="input-group">
                                    <input type="number" id="e-raio" class="form-control" placeholder="500" min="1" max="1000">
                                    <span class="input-group-text">metros</span>
                                </div>
                                <small class="text-muted" style="font-size: 0.65rem;">O ponto será registrado como "Pendente de Aprovação" se fora deste raio.</small>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Segunda-feira</label>
                                <select id="e-seg" class="form-select select-tipo-dia" required>
                                    <option value="Útil">Útil</option>
                                    <option value="Compensado">Compensado</option>
                                    <option value="DSR">DSR</option>
                                </select>
                                <select id="e-seg-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Terça-feira</label>
                                <select id="e-ter" class="form-select select-tipo-dia" required>
                                    <option value="Útil">Útil</option>
                                    <option value="Compensado">Compensado</option>
                                    <option value="DSR">DSR</option>
                                </select>
                                <select id="e-ter-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Quarta-feira</label>
                                <select id="e-qua" class="form-select select-tipo-dia" required>
                                    <option value="Útil">Útil</option>
                                    <option value="Compensado">Compensado</option>
                                    <option value="DSR">DSR</option>
                                </select>
                                <select id="e-qua-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Quinta-feira</label>
                                <select id="e-qui" class="form-select select-tipo-dia" required>
                                    <option value="Útil">Útil</option>
                                    <option value="Compensado">Compensado</option>
                                    <option value="DSR">DSR</option>
                                </select>
                                <select id="e-qui-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Sexta-feira</label>
                                <select id="e-sex" class="form-select select-tipo-dia" required>
                                    <option value="Útil">Útil</option>
                                    <option value="Compensado">Compensado</option>
                                    <option value="DSR">DSR</option>
                                </select>
                                <select id="e-sex-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Sábado</label>
                                <select id="e-sab" class="form-select select-tipo-dia" required>
                                    <option value="Compensado">Compensado</option>
                                    <option value="Útil">Útil</option>
                                    <option value="DSR">DSR</option>
                                </select>
                                <select id="e-sab-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Domingo</label>
                                <select id="e-dom" class="form-select select-tipo-dia" required>
                                    <option value="DSR">DSR</option>
                                    <option value="Útil">Útil</option>
                                    <option value="Compensado">Compensado</option>
                                </select>
                                <select id="e-dom-extra" class="form-select form-select-sm mt-1 select-extra">
                                    <option value="">HE %</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top p-4">
                    <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn-plugin-primary px-5" onclick="salvar()">Salvar Escala</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let modal;
        let horariosCache = [];
        let extrasCache = [];

        function getBadge(tipo, extra) {
            let b = '';
            if (tipo === 'Útil') b = '<span class="badge-day badge-util">ÚTIL</span>';
            else if (tipo === 'DSR') b = '<span class="badge-day badge-dsr">DSR</span>';
            else if (tipo === 'Compensado') b = '<span class="badge-day badge-comp">COMP.</span>';
            else b = tipo;

            if (extra) {
                b += `<br><span class="badge bg-secondary" style="font-size: 0.5rem;">HE ${extra}</span>`;
            }
            return b;
        }
        
        async function carregarFiliais() {
            try {
                const resp = await fetch('/api/filiais');
                const filiais = await resp.json();
                const select = document.getElementById('e-filial');
                select.innerHTML = '<option value="">Selecione...</option>';
                filiais.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.codFilial;
                    opt.textContent = `${f.codFilial} - ${f.nome}`;
                    select.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function carregarHorarios() {
            try {
                const resp = await fetch('/api/horarios');
                horariosCache = await resp.json();
                const select = document.getElementById('e-horario');
                select.innerHTML = '<option value="">Selecione...</option>';
                horariosCache.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.textContent = `${h.filial} | ${h.descricao} (${h.e1}-${h.s2})`;
                    select.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function carregarExtras() {
            try {
                const resp = await fetch('/api/horas-extras');
                extrasCache = await resp.json();
                const selects = document.querySelectorAll('.select-extra');
                selects.forEach(select => {
                    select.innerHTML = '<option value="">HE %</option>';
                    extrasCache.forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.percentual;
                        opt.textContent = `${ex.percentual} (${ex.descricao})`;
                        select.appendChild(opt);
                    });
                });
            } catch (e) { console.error(e); }
        }

        async function carregar() {
            try {
                const resp = await fetch('/api/escalas');
                const escalas = await resp.json();
                const tbody = document.getElementById('lista-escalas');
                tbody.innerHTML = '';
                
                escalas.forEach(e => {
                    const h = horariosCache.find(x => x.id === e.idHorario);
                    const hDesc = h ? `${h.descricao}` : 'N/A';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="fw-bold">${e.filial}</td>
                        <td>${e.codigo}</td>
                        <td><small>${hDesc}</small></td>
                        <td>${getBadge(e.segunda, e.segExtra)}</td>
                        <td>${getBadge(e.terca, e.terExtra)}</td>
                        <td>${getBadge(e.quarta, e.quaExtra)}</td>
                        <td>${getBadge(e.quinta, e.quiExtra)}</td>
                        <td>${getBadge(e.sexta, e.sexExtra)}</td>
                        <td>${getBadge(e.sabado, e.sabExtra)}</td>
                        <td>${getBadge(e.domingo, e.domExtra)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light rounded-3 me-2" onclick="editar(${JSON.stringify(e).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit text-primary"></i>
                            </button>
                            <button class="btn btn-sm btn-light rounded-3" onclick="excluir(${e.id})">
                                <i class="fas fa-trash-can text-danger"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        function toggleCerca() {
            const cerca = document.getElementById('e-cerca').value === 'true';
            document.getElementById('div-raio').style.display = cerca ? 'block' : 'none';
        }

        function abrirModal() {
            document.getElementById('formEscala').reset();
            document.getElementById('e-id').value = '';
            toggleCerca();
            if (!modal) modal = new bootstrap.Modal(document.getElementById('modalEscala'));
            modal.show();
        }

        function editar(e) {
            abrirModal();
            document.getElementById('e-id').value = e.id;
            document.getElementById('e-filial').value = e.filial;
            document.getElementById('e-codigo').value = e.codigo;
            document.getElementById('e-horario').value = e.idHorario;
            document.getElementById('e-seg').value = e.segunda;
            document.getElementById('e-ter').value = e.terca;
            document.getElementById('e-qua').value = e.quarta;
            document.getElementById('e-qui').value = e.quinta;
            document.getElementById('e-sex').value = e.sexta;
            document.getElementById('e-sab').value = e.sabado;
            document.getElementById('e-dom').value = e.domingo;
            
            document.getElementById('e-seg-extra').value = e.segExtra || '';
            document.getElementById('e-ter-extra').value = e.terExtra || '';
            document.getElementById('e-qua-extra').value = e.quaExtra || '';
            document.getElementById('e-qui-extra').value = e.quiExtra || '';
            document.getElementById('e-sex-extra').value = e.sexExtra || '';
            document.getElementById('e-sab-extra').value = e.sabExtra || '';
            document.getElementById('e-dom-extra').value = e.domExtra || '';

            document.getElementById('e-cerca').value = e.cercaVirtual ? 'true' : 'false';
            document.getElementById('e-raio').value = e.raioCerca || '';
            toggleCerca();
        }

        async function salvar() {
            const dados = {
                id: document.getElementById('e-id').value || null,
                filial: document.getElementById('e-filial').value,
                codigo: document.getElementById('e-codigo').value,
                idHorario: document.getElementById('e-horario').value,
                segunda: document.getElementById('e-seg').value,
                terca: document.getElementById('e-ter').value,
                quarta: document.getElementById('e-qua').value,
                quinta: document.getElementById('e-qui').value,
                sexta: document.getElementById('e-sex').value,
                sabado: document.getElementById('e-sab').value,
                domingo: document.getElementById('e-dom').value,
                
                segExtra: document.getElementById('e-seg-extra').value,
                terExtra: document.getElementById('e-ter-extra').value,
                quaExtra: document.getElementById('e-qua-extra').value,
                quiExtra: document.getElementById('e-qui-extra').value,
                sexExtra: document.getElementById('e-sex-extra').value,
                sabExtra: document.getElementById('e-sab-extra').value,
                domExtra: document.getElementById('e-dom-extra').value,

                cercaVirtual: document.getElementById('e-cerca').value === 'true',
                raioCerca: document.getElementById('e-raio').value ? parseInt(document.getElementById('e-raio').value) : null
            };

            if (dados.cercaVirtual && dados.raioCerca > 1000) {
                alert('O raio máximo permitido é de 1000 metros.');
                return;
            }

            if (!dados.filial || !dados.codigo || !dados.idHorario) {
                alert('Preencha os campos obrigatórios.');
                return;
            }

            try {
                const resp = await fetch('/api/escalas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                if (resp.ok) {
                    modal.hide();
                    carregar();
                } else {
                    const msg = await resp.text();
                    alert('Erro: ' + msg);
                }
            } catch (e) { console.error(e); }
        }

        async function excluir(id) {
            if (confirm('Deseja realmente excluir esta escala?')) {
                await fetch(`/api/escalas/${id}`, { method: 'DELETE' });
                carregar();
            }
        }

        window.onload = async () => {
            await carregarFiliais();
            await carregarHorarios();
            await carregarExtras();
            await carregar();
        };
    </script>
</body>
</html>
